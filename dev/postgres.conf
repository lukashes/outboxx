# PostgreSQL configuration for Change Data Capture (CDC)
# This configuration enables logical replication and optimizes for CDC workloads

# Connection settings
listen_addresses = '*'
port = 5432
max_connections = 100

# WAL (Write-Ahead Logging) settings for logical replication
wal_level = logical                    # Enable logical decoding
max_wal_senders = 10                   # Max number of concurrent WAL senders
max_replication_slots = 10             # Max number of replication slots
wal_sender_timeout = 60s               # Timeout for WAL sender

# WAL archiving and retention
archive_mode = off                     # Not needed for development
wal_keep_size = 1GB                    # Keep at least 1GB of WAL files
max_slot_wal_keep_size = 2GB          # Max WAL to retain for replication slots

# Checkpointing and WAL writing
checkpoint_timeout = 5min              # Checkpoint every 5 minutes
checkpoint_completion_target = 0.9     # Spread checkpoint I/O
wal_buffers = 16MB                     # WAL buffer size
wal_writer_delay = 200ms               # WAL writer delay

# Memory settings
shared_buffers = 256MB                 # Shared buffer cache
effective_cache_size = 1GB             # OS cache size estimate
work_mem = 4MB                         # Memory for sorting/hashing
maintenance_work_mem = 64MB            # Memory for maintenance operations

# Query planning
random_page_cost = 1.1                 # Cost of random page access
effective_io_concurrency = 200         # Expected concurrent I/O

# Logging for development and debugging
log_destination = 'stderr'
logging_collector = off
log_min_messages = info                # Log info level and above
log_min_error_statement = error        # Log statements that cause errors
log_statement = 'none'                 # Don't log all statements by default
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# Client connection defaults
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# CDC-specific optimizations
hot_standby_feedback = on              # Prevent query conflicts
wal_receiver_timeout = 60s             # WAL receiver timeout
synchronous_commit = off               # Async commits for better performance (development only)

# Development-specific settings
fsync = off                            # Disable fsync for development (NEVER in production!)
synchronous_commit = off               # Async commits
full_page_writes = off                 # Skip full page writes (development only)

# Replication and logical decoding
max_logical_replication_workers = 4    # Max logical replication workers
max_sync_workers_per_subscription = 2  # Max sync workers per subscription