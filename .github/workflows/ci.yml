name: CI
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    name: CI Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Nix cache
        uses: cachix/cachix-action@v15
        with:
          name: devenv

      # Code Quality Checks
      - name: Lint code formatting
        run: nix develop --command make lint

      - name: Run static analysis with verbose output
        run: |
          nix develop --command zig build --verbose --summary all
          echo "PASS: Static analysis completed"


      # Build and Test
      - name: Build project
        run: nix develop --command make build

      - name: Run unit tests
        run: nix develop --command make test

      - name: Start PostgreSQL for integration tests
        run: nix develop --command make env-up

      - name: Run integration tests
        run: nix develop --command make test-integration
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432

      - name: Stop test environment
        if: always()
        run: nix develop --command make env-down

